---

title: "JavaScriptでイチからeventEmitterを作ってみる"
path: "/2019-07-28-01"
date: "2019-07-28"
# coverImage: "../images/hello.jpg"
excerpt: ''
tags: ['JavaScript', '技術']

---

EventDispatcherをイチから書いて見たのでメモ。

### きっかけ
標準のクリックイベント発火させて伝搬させたりするのってどうするんだっけ, webpackとか使ったりしてるけど普段TSばかり触っていて自作クラス実装する方法だったり理解が曖昧なところがあったのでこのようなことをやってみた

### EventDispatcher とは
イベントをディスパッチ(発行)する関数です。
これを使えば, A をクリックしたときに一緒に B のクリックイベントを起動したり, 独自のイベントを定義したりすることができます。
今回は以下を行います。

- リスナーの登録
- リスナーの削除
- リスナーの取得
- イベントの発火

できたものはこちら。event-dispacher.jsとして保存します。
```js
export class EventDispatcher {
  listenerMap;

  constructor() {
    this.listenerMap = {};
  }

  getListeners = function (eventType) {
    // 定義されていなければinitialize
    if (!this.listenerMap[eventType]) {
      this.listenerMap[eventType] = [];
    }
    return this.listenerMap[eventType];
  }

  addEventListener(eventType, callback, options = {}) {
    const listener = {
      once: !!options.once,
      callback
    };
    this.getListeners(eventType).push(listener);
  }

  /**
  * イベントタイプに登録されているリスナを削除
  */
  removeEventListener(eventType, callback) {
    const listenerList = this.getListeners(eventType);
    const index = listenerList.findIndex((lsn) => lsn.callback === callback);
    if (index >= 0) {
      listenerList.splice(index, 1);
    }
  }

  /**
  * イベントタイプに登録されている各リスナを呼び出す
  * 呼び出し時にはイベントオブジェクトも渡す
  * @type {boolean}
  */
  dispatchEvent(event) {
    const listenerList = this.getListeners(event.type);
    for (const listener of listenerList) {
      listener.callback(event);
    }

    // onceリスナをfilter
    const filtered = listenerList.filter((lsn) => !lsn.once);
    this.listenerMap[event.type] = filtered;
  }
}
```



```js
import { EventDispatcher } from './event_dispatcher.js';

class CounterReceiver extends EventDispatcher {
  constructor() {
    super();
  }
  sample = () => console.log('test');
}

const receiver = new CounterReceiver();
receiver.sample(); // test

const count = document.querySelector('#count');
const incrementElm = document.querySelector('#increment');
const decrementElm = document.querySelector('#decrement');

const incrementCallBack = (event) => {
  count.innerHTML++
};
const decrementCallBack = (event) => {
  count.innerHTML--
};

receiver.addEventListener('decrement', decrementCallBack);
receiver.addEventListener('increment', incrementCallBack);

incrementElm.addEventListener('click', () => receiver.dispatchEvent({ type: 'increment' }));
decrementElm.addEventListener('click', () => receiver.dispatchEvent({ type: 'decrement' }));

```

```html
<html>
<head></head>
<body>
<h1>sample event emitter</h1>
<div>
  <h2 id="count">1</h2>
  <button id="increment">+</button>
  <button id="decrement">-</button>
</div>
</body>
</html>

<script type="module" src="./main.js"></script>

<style>
html, body {
  height: 100%;
}

body {
  display: flex;
  align-items: center;
  background: #333;
  font-family: "PT Sans";
  color: #777;
}

div {
  width: 100%;
}

p {
  text-align: center;
}

h1 {
  text-align: center;
  font-size: 10vh;
  color: #ccc;
  text-shadow: 0 0 3px #000;
  font-weight: bold;
}

h2 {
  font-size: 5vh;
}
</style>

```